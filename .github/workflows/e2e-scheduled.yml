name: Scheduled E2E Tests

on:
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_url:
        description: 'Frontend URL to test'
        required: false
        default: 'https://a0cf.pages.dev'
      api_url:
        description: 'API URL to test'
        required: false
        default: 'https://a0cf-api.d-d1f.workers.dev'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ==========================================
  # Full E2E Test Suite
  # ==========================================
  e2e-full:
    name: Full E2E Test Suite
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    defaults:
      run:
        working-directory: webui
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-webui-${{ hashFiles('webui/pnpm-lock.yaml', 'webui/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-webui-

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}

      - name: Run E2E tests on ${{ matrix.browser }}
        run: pnpm test:e2e --project=${{ matrix.browser }}
        env:
          TEST_URL: ${{ github.event.inputs.test_url || 'https://a0cf.pages.dev' }}
          API_URL: ${{ github.event.inputs.api_url || 'https://a0cf-api.d-d1f.workers.dev' }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: webui/playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}
          path: webui/test-results/
          retention-days: 14

  # ==========================================
  # Mobile E2E Tests
  # ==========================================
  e2e-mobile:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        device: ['Mobile Chrome', 'Mobile Safari']
    defaults:
      run:
        working-directory: webui
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-webui-${{ hashFiles('webui/pnpm-lock.yaml', 'webui/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-webui-

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run Mobile E2E tests
        run: pnpm test:e2e --project="${{ matrix.device }}"
        env:
          TEST_URL: ${{ github.event.inputs.test_url || 'https://a0cf.pages.dev' }}
          API_URL: ${{ github.event.inputs.api_url || 'https://a0cf-api.d-d1f.workers.dev' }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-mobile-${{ matrix.device }}
          path: webui/playwright-report/
          retention-days: 14

  # ==========================================
  # API Health Check
  # ==========================================
  api-health:
    name: API Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API health
        run: |
          API_URL="${{ github.event.inputs.api_url || 'https://a0cf-api.d-d1f.workers.dev' }}"
          
          echo "Checking API health at $API_URL..."
          
          # Health endpoint
          HEALTH=$(curl -s "$API_URL/health")
          echo "Health: $HEALTH"
          
          # CSRF token
          CSRF=$(curl -s "$API_URL/csrf_token")
          echo "CSRF: $CSRF"
          
          # Settings
          SETTINGS=$(curl -s -X POST "$API_URL/settings_get" -H "Content-Type: application/json" -d "{}")
          echo "Settings: $SETTINGS"
          
          # Poll
          POLL=$(curl -s -X POST "$API_URL/poll" -H "Content-Type: application/json" -d "{}")
          echo "Poll: $POLL"
          
          # Verify responses
          if echo "$HEALTH" | grep -q "healthy"; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi

      - name: Check frontend availability
        run: |
          FRONTEND_URL="${{ github.event.inputs.test_url || 'https://a0cf.pages.dev' }}"
          
          echo "Checking frontend at $FRONTEND_URL..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
          
          if [ "$STATUS" = "200" ]; then
            echo "✅ Frontend is available (HTTP $STATUS)"
          else
            echo "❌ Frontend returned HTTP $STATUS"
            exit 1
          fi

  # ==========================================
  # Summary Report
  # ==========================================
  summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-full, e2e-mobile, api-health]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Scheduled E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Desktop Browsers | ${{ needs.e2e-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile Browsers | ${{ needs.e2e-mobile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Health | ${{ needs.api-health.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.e2e-full.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-mobile.result }}" == "failure" ]] || \
             [[ "${{ needs.api-health.result }}" == "failure" ]]; then
            echo "❌ **Some tests failed** - Please investigate." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          fi
